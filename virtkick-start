#!/bin/sh
set -e
cd $(dirname $0)

. setup/system.sh

if ! which virsh &> /dev/null; then
  echo "virsh is not available, please install libvirtd"
fi
export LIBVIRT_VERSION=$(virsh --version)

if ! [ -e webapp/README.md ] || ! [ -e backend/README.md ];then
  echo "Pulling backend and webapp submodules"
  git submodule update --init --recursive
fi

export ISO_DIR="$(realpath ~virtkick)/iso"
export HDD_DIR="$(realpath ~virtkick)/hdd"

. setup/node.sh

if ! [ -e node_modules/.done ];then
  rm -rf node_modules
fi

if ! [ -e node_modules ];then
  npm install
  touch node_modules/.done
fi
. setup/ruby.sh

. setup/python.sh

node starter.js $*

# Remember error
rc=$?
if [[ $rc != 0 ]] ; then
    exit $rc
fi
